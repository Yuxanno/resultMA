/**
 * –ü–†–ò–ú–ï–† –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Ä–æ—É—Ç–∞—Ö
 * 
 * –≠—Ç–æ—Ç —Ñ–∞–π–ª –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–∏–º–µ–Ω—è—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
 * –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤ —Å–≤–æ–∏ —Ä–æ—É—Ç—ã
 */

import { Router } from 'express';
import { cacheMiddleware, invalidateCache } from '../middleware/cache';
import { authenticate } from '../middleware/auth';

const router = Router();

// ============================================
// –ü–†–ò–ú–ï–† 1: –ü—Ä–æ—Å—Ç–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ GET –∑–∞–ø—Ä–æ—Å–∞
// ============================================

// –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ 5 –º–∏–Ω—É—Ç (300 —Å–µ–∫—É–Ω–¥)
router.get('/api/subjects', 
  authenticate, 
  cacheMiddleware(300), 
  async (req, res) => {
    // –í–∞—à –∫–æ–¥ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    const subjects: any[] = []; // await Subject.find()
    res.json(subjects);
  }
);

// ============================================
// –ü–†–ò–ú–ï–† 2: –†–∞–∑–Ω–æ–µ –≤—Ä–µ–º—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
// ============================================

// –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ - –∫—ç—à –Ω–∞ 1 —á–∞—Å
router.get('/api/directions', 
  cacheMiddleware(3600), 
  async (req, res) => {
    // –†–µ–¥–∫–æ –º–µ–Ω—è—é—â–∏–µ—Å—è –¥–∞–Ω–Ω—ã–µ
  }
);

// –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ - –∫—ç—à –Ω–∞ 1 –º–∏–Ω—É—Ç—É
router.get('/api/tests', 
  authenticate,
  cacheMiddleware(60), 
  async (req, res) => {
    // –ß–∞—Å—Ç–æ –º–µ–Ω—è—é—â–∏–µ—Å—è –¥–∞–Ω–Ω—ã–µ
  }
);

// ============================================
// –ü–†–ò–ú–ï–† 3: –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
// ============================================

router.post('/api/subjects', 
  authenticate, 
  async (req, res) => {
    // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞
    // const subject = await Subject.create(req.body);
    
    // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫—ç—à —Å–ø–∏—Å–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
    await invalidateCache('/api/subjects');
    
    res.json({ success: true });
  }
);

router.put('/api/subjects/:id', 
  authenticate, 
  async (req, res) => {
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞
    // await Subject.findByIdAndUpdate(req.params.id, req.body);
    
    // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫—ç—à
    await invalidateCache('/api/subjects');
    
    res.json({ success: true });
  }
);

router.delete('/api/subjects/:id', 
  authenticate, 
  async (req, res) => {
    // –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞
    // await Subject.findByIdAndDelete(req.params.id);
    
    // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫—ç—à
    await invalidateCache('/api/subjects');
    
    res.json({ success: true });
  }
);

// ============================================
// –ü–†–ò–ú–ï–† 4: –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω—É
// ============================================

router.post('/api/tests', 
  authenticate, 
  async (req, res) => {
    // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞
    
    // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å /api/tests
    await invalidateCache('/api/tests');
    
    // –≠—Ç–æ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç:
    // - /api/tests
    // - /api/tests?page=1
    // - /api/tests/123
    // - /api/tests/search?q=math
    
    res.json({ success: true });
  }
);

// ============================================
// –ü–†–ò–ú–ï–† 5: –£—Å–ª–æ–≤–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
// ============================================

router.get('/api/statistics', 
  authenticate, 
  async (req: any, res) => {
    // –î–ª—è –∞–¥–º–∏–Ω–æ–≤ - –±–µ–∑ –∫—ç—à–∞ (–≤—Å–µ–≥–¥–∞ —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ)
    if (req.user?.role === 'SUPER_ADMIN') {
      const stats = {}; // await getStatistics()
      return res.json(stats);
    }
    
    // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö - –∫—ç—à –Ω–∞ 10 –º–∏–Ω—É—Ç
    const middleware = cacheMiddleware(600);
    return middleware(req, res, async () => {
      const stats = {}; // await getStatistics()
      res.json(stats);
    });
  }
);

// ============================================
// –ü–†–ò–ú–ï–† 6: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å query –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
// ============================================

// –ö—ç—à —É—á–∏—Ç—ã–≤–∞–µ—Ç query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
router.get('/api/tests/search', 
  authenticate,
  cacheMiddleware(300), 
  async (req, res) => {
    const { q, subject, page } = req.query;
    
    // /api/tests/search?q=math&page=1 - –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫—ç—à
    // /api/tests/search?q=physics&page=1 - –¥—Ä—É–≥–æ–π –∫—ç—à
    
    const tests: any[] = []; // await Test.find({ ... })
    res.json(tests);
  }
);

// ============================================
// –ü–†–ò–ú–ï–† 7: –ù–µ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
// ============================================

// –ù–ï –ö–≠–®–ò–†–û–í–ê–¢–¨ - –¥–∞–Ω–Ω—ã–µ –∑–∞–≤–∏—Å—è—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
router.get('/api/my-profile', 
  authenticate, 
  async (req, res) => {
    // –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∞—Ç—å —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ
    const profile = {}; // await User.findById(req.user.id)
    res.json(profile);
  }
);

// ============================================
// –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò
// ============================================

/**
 * ‚úÖ –ö–≠–®–ò–†–û–í–ê–¢–¨:
 * - –°–ø–∏—Å–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ (subjects, directions, branches)
 * - –ü—É–±–ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
 * - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (—Å –∫–æ—Ä–æ—Ç–∫–∏–º TTL)
 * - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
 * - –°–ø–∏—Å–∫–∏ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
 * 
 * ‚ùå –ù–ï –ö–≠–®–ò–†–û–í–ê–¢–¨:
 * - –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * - –î–∞–Ω–Ω—ã–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
 * - POST/PUT/DELETE –∑–∞–ø—Ä–æ—Å—ã
 * - –î–∞–Ω–Ω—ã–µ —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π –ø–æ —Ç–æ–∫–µ–Ω—É
 * - –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
 * 
 * ‚è±Ô∏è –í–†–ï–ú–Ø –ö–≠–®–ò–†–û–í–ê–ù–ò–Ø:
 * - –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏: 1-24 —á–∞—Å–∞
 * - –°–ø–∏—Å–∫–∏ —Å —Ä–µ–¥–∫–∏–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏: 5-15 –º–∏–Ω—É—Ç
 * - –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ: 1-5 –º–∏–Ω—É—Ç
 * - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: 5-10 –º–∏–Ω—É—Ç
 * 
 * üîÑ –ò–ù–í–ê–õ–ò–î–ê–¶–ò–Ø:
 * - –í—Å–µ–≥–¥–∞ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–π—Ç–µ –ø—Ä–∏ CREATE/UPDATE/DELETE
 * - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –≥—Ä—É–ø–ø–æ–≤–æ–π –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏
 * - –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–π—Ç–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
 */

export default router;
