# üîê –ó–∞–¥–∞—á–∞ #3: –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞

## üìä –°—Ç–∞—Ç—É—Å: üìñ –°–ü–†–ê–í–û–ß–ù–ê–Ø

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –ò–ù–§–û–†–ú–ê–¶–ò–Ø  
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-01-XX

---

## üéØ –û–ø–∏—Å–∞–Ω–∏–µ

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Å–∏—Å—Ç–µ–º–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –ø—Ä–∞–≤–∞–º –¥–æ—Å—Ç—É–ø–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.

---

## üë• –†–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### 1. SUPER_ADMIN
**–ü—Ä–∞–≤–∞:**
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ–º–∏ —Ñ–∏–ª–∏–∞–ª–∞–º–∏
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- ‚úÖ –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
- ‚úÖ –°–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- ‚ùå –ù–µ –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç–µ—Å—Ç—ã (–Ω–µ —É—á–∏—Ç–µ–ª—å)

### 2. BRANCH_ADMIN
**–ü—Ä–∞–≤–∞:**
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≤–æ–∏–º —Ñ–∏–ª–∏–∞–ª–æ–º
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–∏—Ç–µ–ª—è–º–∏ —Ñ–∏–ª–∏–∞–ª–∞
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–∞–º–∏ —Ñ–∏–ª–∏–∞–ª–∞
- ‚úÖ –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ñ–∏–ª–∏–∞–ª–∞

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- ‚ùå –ù–µ –≤–∏–¥–∏—Ç –¥—Ä—É–≥–∏–µ —Ñ–∏–ª–∏–∞–ª—ã
- ‚ùå –ù–µ –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç–µ—Å—Ç—ã (–Ω–µ —É—á–∏—Ç–µ–ª—å)

### 3. TEACHER
**–ü—Ä–∞–≤–∞:**
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –±–ª–æ–∫-—Ç–µ—Å—Ç–æ–≤
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≤–æ–∏–º–∏ –≥—Ä—É–ø–ø–∞–º–∏
- ‚úÖ –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–≤–æ–∏—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
- ‚úÖ –ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å–≤–æ–∏—Ö —Ç–µ—Å—Ç–æ–≤

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- ‚ùå –í–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Ç–µ—Å—Ç—ã (`createdBy: userId`)
- ‚ùå –í–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–π —Ñ–∏–ª–∏–∞–ª (`branchId`)
- ‚ùå –ù–µ –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –¥—Ä—É–≥–∏–º–∏ —É—á–∏—Ç–µ–ª—è–º–∏

---

## üîë –°–∏—Å—Ç–µ–º–∞ —Ç–æ–∫–µ–Ω–æ–≤

### JWT Token
**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```typescript
{
  id: string;           // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  role: string;         // –†–æ–ª—å (SUPER_ADMIN, BRANCH_ADMIN, TEACHER)
  branchId?: string;    // ID —Ñ–∏–ª–∏–∞–ª–∞ (–µ—Å–ª–∏ –Ω–µ SUPER_ADMIN)
  iat: number;          // –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è
  exp: number;          // –í—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è (24 —á–∞—Å–∞)
}
```

**–•—Ä–∞–Ω–µ–Ω–∏–µ:**
- –ö–ª–∏–µ–Ω—Ç: `localStorage.getItem('token')`
- –°–µ—Ä–≤–µ—Ä: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ middleware `authenticate`

### Middleware authenticate
**–§–∞–π–ª:** `server/src/middleware/auth.ts`

**–õ–æ–≥–∏–∫–∞:**
```typescript
export const authenticate = async (req: Request, res: Response, next: NextFunction) => {
  const token = req.headers.authorization?.replace('Bearer ', '');
  
  if (!token) {
    return res.status(401).json({ message: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' });
  }
  
  try {
    const decoded = jwt.verify(token, JWT_SECRET);
    req.user = decoded; // { id, role, branchId }
    next();
  } catch (error) {
    return res.status(401).json({ message: '–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω' });
  }
};
```

---

## üõ°Ô∏è –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

### –¢–µ—Å—Ç—ã (GET /tests)
```typescript
const filter: any = {};

// –§–∏–ª—å—Ç—Ä –ø–æ —Ñ–∏–ª–∏–∞–ª—É (–¥–ª—è –Ω–µ-—Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–æ–≤)
if (req.user?.branchId) {
  filter.branchId = req.user.branchId;
}

// –§–∏–ª—å—Ç—Ä –ø–æ —Å–æ–∑–¥–∞—Ç–µ–ª—é (–¥–ª—è —É—á–∏—Ç–µ–ª–µ–π)
if (req.user?.role === 'TEACHER') {
  filter.createdBy = req.user.id;
}

const tests = await Test.find(filter);
```

### –ë–ª–æ–∫-—Ç–µ—Å—Ç—ã (GET /block-tests)
```typescript
const blockTests = await BlockTest.find({ 
  branchId: req.user?.branchId 
});
```

### –°—Ç—É–¥–µ–Ω—Ç—ã (GET /students)
```typescript
const filter: any = {};

if (req.user?.branchId) {
  filter.branchId = req.user.branchId;
}

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
if (groupId) filter.groupId = groupId;
if (classNumber) filter.classNumber = classNumber;

const students = await Student.find(filter);
```

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞

### –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–µ—Å—Ç–∞
```typescript
// POST /tests/import/confirm
const test = new Test({
  name: testName,
  groupId,
  subjectId,
  questions,
  branchId: req.user?.branchId,  // ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ —Ç–æ–∫–µ–Ω–∞
  createdBy: req.user?.id         // ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ —Ç–æ–∫–µ–Ω–∞
});
```

### –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–µ—Å—Ç–∞
```typescript
// PUT /tests/:id
const test = await Test.findById(req.params.id);

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
if (test.createdBy.toString() !== req.user?.id) {
  return res.status(403).json({ message: '–ù–µ—Ç –ø—Ä–∞–≤' });
}
```

### –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–µ—Å—Ç–∞
```typescript
// DELETE /tests/:id
const test = await Test.findById(req.params.id);

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
if (test.createdBy.toString() !== req.user?.id) {
  return res.status(403).json({ message: '–ù–µ—Ç –ø—Ä–∞–≤' });
}
```

---

## üêõ –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞ #1: branchId –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è
**–°–∏–º–ø—Ç–æ–º—ã:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∏–¥–∏—Ç —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ

**–ü—Ä–∏—á–∏–Ω–∞:** `branchId` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Ç–æ–∫–µ–Ω–µ

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞ (login)
const token = jwt.sign(
  { 
    id: user._id, 
    role: user.role,
    branchId: user.branchId  // ‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å
  },
  JWT_SECRET,
  { expiresIn: '24h' }
);
```

### –ü—Ä–æ–±–ª–µ–º–∞ #2: –¢–æ–∫–µ–Ω —É—Å—Ç–∞—Ä–µ–ª
**–°–∏–º–ø—Ç–æ–º—ã:** 401 Unauthorized

**–†–µ—à–µ–Ω–∏–µ:**
```javascript
// –í –±—Ä–∞—É–∑–µ—Ä–µ (Console)
localStorage.removeItem('token');
// –ü–µ—Ä–µ–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è
```

### –ü—Ä–æ–±–ª–µ–º–∞ #3: –†–æ–ª—å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
**–°–∏–º–ø—Ç–æ–º—ã:** –£—á–∏—Ç–µ–ª—å –≤–∏–¥–∏—Ç —á—É–∂–∏–µ —Ç–µ—Å—Ç—ã –∏–ª–∏ –Ω–µ –≤–∏–¥–∏—Ç —Å–≤–æ–∏

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
if (req.user?.role === 'TEACHER') {
  filter.createdBy = req.user.id;
}

// –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
if (req.user?.role === 'teacher') { // ‚ùå –†–µ–≥–∏—Å—Ç—Ä –≤–∞–∂–µ–Ω!
  filter.createdBy = req.user.id;
}
```

---

## üîß –û—Ç–ª–∞–¥–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω –≤ –±—Ä–∞—É–∑–µ—Ä–µ
```javascript
// Console
const token = localStorage.getItem('token');
console.log('Token:', token);

// –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω (–±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏)
const payload = JSON.parse(atob(token.split('.')[1]));
console.log('Payload:', payload);
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
```typescript
// –í –ª—é–±–æ–º —Ä–æ—É—Ç–µ
console.log('üîç User:', {
  id: req.user?.id,
  role: req.user?.role,
  branchId: req.user?.branchId
});
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
```bash
mongosh "mongodb://localhost:27017/resultma"
db.users.findOne({ _id: ObjectId('USER_ID') })
```

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `server/src/middleware/auth.ts` - Middleware –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- `server/src/middleware/permissions.ts` - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
- `server/src/models/User.ts` - –ú–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `client/src/store/authStore.ts` - –•—Ä–∞–Ω–∏–ª–∏—â–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

---

## üìù –ß–µ–∫–ª–∏—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤

- [ ] –¢–æ–∫–µ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç `id`, `role`, `branchId`
- [ ] –¢–æ–∫–µ–Ω –Ω–µ –∏—Å—Ç–µ–∫ (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å `exp`)
- [ ] –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è
- [ ] `branchId` —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ –≤ –ë–î
- [ ] –§–∏–ª—å—Ç—Ä—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- [ ] –£—á–∏—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Ç–µ—Å—Ç—ã
- [ ] –ê–¥–º–∏–Ω –≤–∏–¥–∏—Ç –≤—Å–µ —Ç–µ—Å—Ç—ã —Ñ–∏–ª–∏–∞–ª–∞

---

**–°—Ç–∞—Ç—É—Å:** –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–∞
